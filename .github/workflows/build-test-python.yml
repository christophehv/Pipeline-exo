name: 1ï¸âƒ£ Build & Test Python

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ³ Build de l'image Docker
        run: |
          docker build -t pipeline-python:latest .
          echo "âœ… Image Docker construite avec succÃ¨s"

      - name: ğŸš€ Lancer le conteneur en mode dÃ©tachÃ©
        run: |
          docker run -d \
            --name pipeline_python_test \
            -p 5000:5000 \
            pipeline-python:latest
          echo "âœ… Conteneur lancÃ© en mode dÃ©tachÃ©"

          # Attendre que le conteneur soit prÃªt
          sleep 5

      - name: ğŸ“‹ Lire les logs et chercher un pattern
        run: |
          echo "ğŸ” Lecture des logs du conteneur..."
          docker logs pipeline_python_test > /tmp/container_logs.txt

          # Afficher les logs
          cat /tmp/container_logs.txt

          # Chercher le pattern "DÃ©marrage" ou "Running"
          if grep -iE "(dÃ©marrage|running|started)" /tmp/container_logs.txt; then
            echo "âœ… Pattern distinctif trouvÃ© dans les logs"
          else
            echo "âš ï¸  Pattern non trouvÃ©, affichage des logs disponibles..."
            docker logs pipeline_python_test
          fi

      - name: âœ… VÃ©rifier l'Ã©tat du conteneur
        run: |
          echo "ğŸ” VÃ©rification de l'Ã©tat du conteneur..."

          # VÃ©rifier que le conteneur est en cours d'exÃ©cution
          if docker ps | grep -q pipeline_python_test; then
            echo "âœ… Le conteneur est en cours d'exÃ©cution (Up)"
          else
            echo "âŒ Le conteneur n'est pas en cours d'exÃ©cution"
            docker ps -a
            exit 1
          fi

      - name: ğŸŒ Smoke Test - RequÃªte HTTP
        run: |
          echo "ğŸ” ExÃ©cution du smoke test..."

          # Attendre que l'application soit prÃªte
          for i in {1..30}; do
            if curl -s http://localhost:5000/health > /dev/null 2>&1; then
              echo "âœ… L'application rÃ©pond sur /health"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ L'application n'a pas rÃ©pondu aprÃ¨s 30 tentatives"
              docker logs pipeline_python_test
              exit 1
            fi
            echo "â³ Tentative $i... en attente de rÃ©ponse"
            sleep 1
          done

      - name: ğŸ§ª Tests dÃ©taillÃ©s des endpoints
        run: |
          echo "ğŸ” Tests des endpoints..."

          # Test endpoint /
          echo "Test GET /"
          curl -v http://localhost:5000/

          # Test endpoint /health
          echo -e "\n\nTest GET /health"
          curl -v http://localhost:5000/health

          # Test endpoint /version
          echo -e "\n\nTest GET /version"
          curl -v http://localhost:5000/version

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Nettoyage..."
          docker stop pipeline_python_test || true
          docker rm pipeline_python_test || true
          echo "âœ… Nettoyage terminÃ©"
