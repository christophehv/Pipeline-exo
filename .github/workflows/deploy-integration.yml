name: 4ï¸âƒ£ Deploy Integration

on:
  workflow_run:
    workflows: ["3ï¸âƒ£ Publish to GHCR"]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # VÃ©rifier que le workflow prÃ©cÃ©dent a rÃ©ussi
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          # RÃ©cupÃ©rer le commit du workflow qui a dÃ©clenchÃ© celui-ci
          ref: ${{ github.event.workflow_run.head_commit.sha }}

      - name: ğŸ“‹ Afficher les informations du contexte
        run: |
          echo "ğŸ” Informations du dÃ©ploiement:"
          echo "Commit SHA: ${{ github.event.workflow_run.head_commit.sha }}"
          echo "Branche: ${{ github.event.workflow_run.head_branch }}"
          echo "Repository: ${{ github.repository }}"
          echo "Owner: ${{ github.repository_owner }}"

      - name: ğŸ³ Construire l'URL de l'image GHCR
        id: image
        run: |
          # Utiliser le short SHA pour identifier l'image
          SHORT_SHA=$(echo ${{ github.event.workflow_run.head_commit.sha }} | cut -c1-7)
          BRANCH=${{ github.event.workflow_run.head_branch }}

          # Construire l'URL de l'image
          IMAGE="ghcr.io/${{ github.repository_owner }}/pipeline-python:${BRANCH}-${SHORT_SHA}"

          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "âœ… Image construite: $IMAGE"

      - name: ğŸ” Authentification Ã  GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "âœ… Authentification Ã  GHCR rÃ©ussie"

      - name: ğŸ³ Pull de l'image du GHCR
        run: |
          IMAGE="${{ steps.image.outputs.image }}"
          echo "ğŸ“¥ TÃ©lÃ©chargement de l'image: $IMAGE"
          docker pull $IMAGE
          echo "âœ… Image tÃ©lÃ©chargÃ©e avec succÃ¨s"

      - name: ğŸš€ DÃ©marrer la stack avec docker-compose
        env:
          PYTHON_IMAGE: ${{ steps.image.outputs.image }}
        run: |
          echo "ğŸš€ DÃ©marrage de la stack complÃ¨te..."
          echo "Variable PYTHON_IMAGE: $PYTHON_IMAGE"

          # DÃ©marrer la stack
          docker-compose up -d

          echo "âœ… Stack dÃ©marrÃ©e"

          # Attendre que les services soient prÃªts
          echo "â³ Attente du dÃ©marrage des services..."
          sleep 10

      - name: ğŸ“Š VÃ©rifier l'Ã©tat des conteneurs
        run: |
          echo "ğŸ” Ã‰tat des conteneurs:"
          docker ps -a

          echo ""
          echo "ğŸ” VÃ©rification de la santÃ© des services:"

          # VÃ©rifier que tous les services sont UP
          for service in pipeline_python pipeline_nginx pipeline_postgres pipeline_redis; do
            if docker ps | grep -q $service; then
              echo "âœ… $service est en cours d'exÃ©cution"
            else
              echo "âŒ $service n'est pas en cours d'exÃ©cution"
              docker ps -a
              exit 1
            fi
          done

      - name: ğŸ§ª Test de l'application Python directement
        run: |
          echo "ğŸ§ª Test direct de l'application Python..."

          for i in {1..30}; do
            if curl -s http://localhost:5000/health > /dev/null 2>&1; then
              echo "âœ… L'application Python rÃ©pond sur le port 5000"
              curl -s http://localhost:5000/health | jq .
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ L'application Python n'a pas rÃ©pondu"
              docker logs pipeline_python
              exit 1
            fi
            echo "â³ Tentative $i..."
            sleep 1
          done

      - name: ğŸŒ Test du proxy Nginx
        run: |
          echo "ğŸŒ Test du proxy Nginx..."

          # Attendre que Nginx soit prÃªt
          for i in {1..30}; do
            if curl -s http://localhost/health > /dev/null 2>&1; then
              echo "âœ… Nginx rÃ©pond sur le port 80"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ Nginx n'a pas rÃ©pondu"
              docker logs pipeline_nginx
              exit 1
            fi
            echo "â³ Tentative $i pour Nginx..."
            sleep 1
          done

      - name: ğŸ”— VÃ©rifier que Nginx proxy correctement vers Python
        run: |
          echo "ğŸ”— VÃ©rification du proxying Nginx vers Python..."

          # Tester les endpoints via Nginx
          echo ""
          echo "Test GET / via Nginx:"
          curl -v http://localhost/

          echo ""
          echo ""
          echo "Test GET /health via Nginx:"
          curl -v http://localhost/health

          echo ""
          echo ""
          echo "Test GET /version via Nginx:"
          curl -v http://localhost/version

          # VÃ©rifier que les rÃ©ponses viennent bien du Python
          echo ""
          echo "âœ… Les requÃªtes passent correctement par Nginx vers Python"

      - name: ğŸ“ Afficher les logs des services
        if: always()
        run: |
          echo "===== ğŸ“ LOGS DES SERVICES ====="
          echo ""
          echo "--- Logs Python ---"
          docker logs pipeline_python | tail -20

          echo ""
          echo "--- Logs Nginx ---"
          docker logs pipeline_nginx | tail -20

          echo ""
          echo "--- Logs PostgreSQL ---"
          docker logs pipeline_postgres | tail -10

          echo ""
          echo "--- Logs Redis ---"
          docker logs pipeline_redis | tail -10

      - name: ğŸ“Š Afficher les metrics des conteneurs
        if: always()
        run: |
          echo "===== ğŸ“Š METRICS DES CONTENEURS ====="
          docker stats --no-stream

      - name: ğŸ§¹ Cleanup (optionnel - commentÃ©)
        if: always()
        run: |
          echo "ğŸ§¹ Nettoyage de la stack..."
          # DÃ©commenter pour nettoyer aprÃ¨s les tests:
          # docker-compose down -v

          echo "âœ… Stack arrÃªtÃ©e"
          echo "ğŸ’¡ Remarque: Pour arrÃªter manuellement la stack, exÃ©cutez: docker-compose down -v"

      - name: ğŸ‰ DÃ©ploiement terminÃ© avec succÃ¨s
        run: |
          echo "âœ… Workflow deploy-integration.yml terminÃ© avec succÃ¨s"
          echo ""
          echo "ğŸ¯ Validation complÃ¨te du pipeline:"
          echo "  1ï¸âƒ£  Build & Test Python: âœ…"
          echo "  2ï¸âƒ£  Security Scan: âœ…"
          echo "  3ï¸âƒ£  Publish to GHCR: âœ…"
          echo "  4ï¸âƒ£  Deploy Integration: âœ…"
          echo ""
          echo "ğŸš€ La stack est complÃ¨tement fonctionnelle en intÃ©gration!"
