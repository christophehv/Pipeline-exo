name: 2Ô∏è‚É£ Security Scan

on:
  workflow_run:
    workflows: ["1Ô∏è‚É£ Build & Test Python"]
    types: [completed]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    # V√©rifier que le workflow pr√©c√©dent a r√©ussi
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üîê Installer Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | tee -a /etc/apt/sources.list.d/trivy.list
          apt-get update
          apt-get install -y trivy
          echo "‚úÖ Trivy install√© avec succ√®s"

      - name: üîç Scanner nginx:alpine avec Trivy
        id: trivy_nginx
        continue-on-error: true
        run: |
          echo "üîç Scan de l'image nginx:alpine..."
          trivy image --exit-code 0 --severity HIGH,CRITICAL --format json nginx:alpine > /tmp/nginx-scan.json

          # Afficher les r√©sultats
          echo "üìã R√©sultats du scan nginx:alpine:"
          trivy image --severity HIGH,CRITICAL nginx:alpine

          # Compter les vuln√©rabilit√©s CRITICAL
          CRITICAL_COUNT=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity=="CRITICAL")] | length' /tmp/nginx-scan.json 2>/dev/null || echo 0)
          echo "nginx_critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT

          # V√©rifier les CRITICAL dans les vuln√©rabilit√©s
          CRITICAL_VULNS=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' /tmp/nginx-scan.json 2>/dev/null || echo 0)
          echo "nginx_critical_vulns=$CRITICAL_VULNS" >> $GITHUB_OUTPUT

          echo "Vuln√©rabilit√©s CRITICAL trouv√©es : $CRITICAL_VULNS"

      - name: üîç Scanner postgres:alpine avec Trivy
        id: trivy_postgres
        continue-on-error: true
        run: |
          echo "üîç Scan de l'image postgres:alpine..."
          trivy image --exit-code 0 --severity HIGH,CRITICAL --format json postgres:alpine > /tmp/postgres-scan.json

          # Afficher les r√©sultats
          echo "üìã R√©sultats du scan postgres:alpine:"
          trivy image --severity HIGH,CRITICAL postgres:alpine

          # Compter les vuln√©rabilit√©s CRITICAL
          CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' /tmp/postgres-scan.json 2>/dev/null || echo 0)
          echo "postgres_critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "Vuln√©rabilit√©s CRITICAL trouv√©es : $CRITICAL_COUNT"

      - name: üîç Scanner redis:alpine avec Trivy
        id: trivy_redis
        continue-on-error: true
        run: |
          echo "üîç Scan de l'image redis:alpine..."
          trivy image --exit-code 0 --severity HIGH,CRITICAL --format json redis:alpine > /tmp/redis-scan.json

          # Afficher les r√©sultats
          echo "üìã R√©sultats du scan redis:alpine:"
          trivy image --severity HIGH,CRITICAL redis:alpine

          # Compter les vuln√©rabilit√©s CRITICAL
          CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' /tmp/redis-scan.json 2>/dev/null || echo 0)
          echo "redis_critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "Vuln√©rabilit√©s CRITICAL trouv√©es : $CRITICAL_COUNT"

      - name: üìä R√©capitulatif des scans
        run: |
          echo "===== üìä R√âCAPITULATIF DES SCANS ====="
          echo ""
          echo "nginx:alpine"
          echo "  - CRITICAL: ${{ steps.trivy_nginx.outputs.nginx_critical_vulns || 0 }}"
          echo ""
          echo "postgres:alpine"
          echo "  - CRITICAL: ${{ steps.trivy_postgres.outputs.postgres_critical || 0 }}"
          echo ""
          echo "redis:alpine"
          echo "  - CRITICAL: ${{ steps.trivy_redis.outputs.redis_critical || 0 }}"
          echo ""

      - name: ‚ùå V√©rifier les vuln√©rabilit√©s CRITICAL
        run: |
          NGINX_CRITICAL=${{ steps.trivy_nginx.outputs.nginx_critical_vulns || 0 }}
          POSTGRES_CRITICAL=${{ steps.trivy_postgres.outputs.postgres_critical || 0 }}
          REDIS_CRITICAL=${{ steps.trivy_redis.outputs.redis_critical || 0 }}

          TOTAL_CRITICAL=$((NGINX_CRITICAL + POSTGRES_CRITICAL + REDIS_CRITICAL))

          if [ "$TOTAL_CRITICAL" -gt 0 ]; then
            echo "‚ùå ‚ö†Ô∏è ERREUR : $TOTAL_CRITICAL vuln√©rabilit√©(s) CRITICAL trouv√©e(s) !"
            echo "Le job doit √©chouer car il y a des vuln√©rabilit√©s CRITICAL"
            exit 1
          else
            echo "‚úÖ Aucune vuln√©rabilit√© CRITICAL trouv√©e - Scan r√©ussi !"
          fi

      - name: üìà Upload des r√©sultats de scan
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results
          path: /tmp/*-scan.json
          retention-days: 30

      - name: üéâ Scan termin√© avec succ√®s
        run: |
          echo "‚úÖ Workflow security-scan.yml termin√© avec succ√®s"
          echo "Les images d'infrastructure ont pass√© la v√©rification de s√©curit√©"
          echo ""
          echo "Prochaine √©tape: publish-ghcr.yml sera d√©clench√© automatiquement"
